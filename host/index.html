<html>
  <head>
    <title>Phone Party</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' />
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <div id="introduction-page" class="hide">
      <h1>Join our game!</h1>
      <h2>1. Connect to the Game Jam WiFi</h2>
      <p>sid: ??  password: ??</p>
      <h2>2. Go to <em>jam.joshshone.com</em><h2>
    </div>
    <div id="waiting-for-players" class="hide">
      <h1>Waiting for players...</h1>
    </div>
    <div id="phase1" class="hide">
      <h1>Find this item!</h1>
      <div class="item"></div>
      <div class="remaining-time"></div>
    </div>
    <div id="pause-indicator">‚è∏</div>
    <div id="connection-status"></div>
    <div id="warning-indicator"></div>
  </body>
  <script src="utils.js"></script>
  <script src="handlePlayer.js"></script>
  <script src="phase1.js"></script>
  <script src="phase2.js"></script>
  <script src="phase3.js"></script>
  <script src="phase4.js"></script>
  <script src="idCounter.js"></script>
  <script src="jQuery.js"></script>
  <script>
    "use strict";

    // Redirect to HTTPS
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && !location.hostname.startsWith('192.168.') && location.protocol !== 'file:') {
      location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
    }

    const connectionStatus = document.getElementById('connection-status');
    const warningIndicator = document.getElementById('warning-indicator');

    if (location.protocol === 'file:') {
      const message = 'Cannot open websocket because this page is loaded with the file protocol.';
      connectionStatus.className = 'error';
      connectionStatus.textContent = message;
      throw message;
    }

    const players = [];

    // Open websocket and receive players
    (async function() {
      connectionStatus.className = 'connecting';
      while (true) {
        const websocket = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.hostname}:${location.port}/host/ws`);
        websocket.onopen = () => connectionStatus.className = '';

        websocket.onmessage = event => {
          const message = JSON.parse(event.data);
          if (message.type !== 'playerDisconnected' && JSON.parse(message.message).sdp) {
            handleNewPlayer(message.playerId, JSON.parse(message.message).sdp, websocket);
          }
        }

        // If the websocket disconnects, continue the loop and try to connect again
        await new Promise(resolve => websocket.onclose = resolve);
        warningIndicator.textContent = 'Websocket disconnected, reconnecting in 5 seconds';
        await new Promise(resolve => setTimeout(() => resolve(), 5000));
        warningIndicator.textContent = 'Websocket reconnecting..';
        await new Promise(resolve => setTimeout(() => resolve(), 1000));
        warningIndicator.textContent = '';
      }
    })();

    let paused = false;
    window.addEventListener('keydown', event => {
      if (event.key === 'p') {
        paused = !paused;
        document.getElementById('pause-indicator').classList.toggle('activated', paused);
      }
    });
  </script>
  <script src="gameplay.js"></script>
</html>
