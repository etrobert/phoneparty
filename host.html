<html>
  <head>
  </head>
  <body>
    <h1>HOST</h1>
    <div id="statusbar">
      <span id="websocket_status" class="initial">WS</span>
      <span id="rtc_status"       class="initial">RTC</span>
    </div>
    <div id="videos"></div>
  </body>
  <style>
    h1 {
      position: fixed;
      top: 10vh;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 2;
    }
    #videos {
      position: fixed;
      left:   0;
      top:    0;
      width:  100%;
      height: 100%;
      display: flex;
      flex-direction: row;
    }
    #videos video {
      flex-grow: 1;
      flex-shrink: 0;
      object-fit: cover;
      flex-basis: 1px;
      transform: scaleX(-1);
      -webkit-border-radius: 1px; /* workaround for Chrome (video overhangs element) */
    }
    #statusbar {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      z-index: 2;
      text-align: right;
    }
    #statusbar span {
      height: 5vh;
      width: 5vh;
      font-size: 2vh;
      display: inline-flex;
      justify-content: center;
      align-items: center;
    }
    #statusbar span.initial      { background-color: grey;  }
    #statusbar span.connected    { background-color: green; }
    #statusbar span.disconnected { background-color: red; }
  </style>
  <script>
    // HTTPS redirect
    if (location.hostname !== 'localhost' && !location.hostname.startsWith('192.168.') && location.protocol != 'https:') {
      location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
    }

    const websocket = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.hostname}:${location.port}/host`);
    const websocketStatus = document.getElementById('websocket_status');
    websocket.addEventListener('open', function (event) {
      console.log('Websocket opened');
      websocketStatus.className = 'connected';
    });

    const rtcConnections = {};
    
    // Listen for messages
    websocket.addEventListener('message', function (event) {
      const clientIdAndMessage = JSON.parse(event.data);
      const clientId = clientIdAndMessage[0];
      console.log(`Received websocket message from client ${clientId}`);
      
      if (!(clientId in rtcConnections)) {
        console.log('New client connected')
      
        async function setupRtcConnection() {
          const rtcConnection = new RTCPeerConnection({});
          rtcConnections[clientId] = rtcConnection;
          rtcConnection.addEventListener('iceconnectionstatechange', event => {
            console.log('ICE connection state changed to: ' + rtcConnection.iceConnectionState);
          });
          let hasSentSdp = false;
          let iceCandidatesToSend = [];
          rtcConnection.addEventListener('icecandidate', event => {
            console.log('Got local ICE candidate');
            if (event.candidate) {
              iceCandidatesToSend.push(JSON.stringify({candidate: event.candidate.candidate, sdpMid: event.candidate.sdpMid, sdpMLineIndex: event.candidate.sdpMLineIndex}));
              if (hasSentSdp) {
                sendIceCandidates();
              }
            }
          });
          function sendIceCandidates() {
            for (let iceCandidate of iceCandidatesToSend) {
              console.log('Sending ICE candidate..');
              websocket.send(JSON.stringify([clientId, iceCandidate]));
            }
            iceCandidatesToSend = [];
          }

          const video = document.createElement('video');
          video.autoplay = true;
          document.getElementById('videos').appendChild(video);
          rtcConnection.addEventListener('track', event => {
            console.log('Got track from RTC connection');
            if (video.srcObject !== event.streams[0]) {
              video.srcObject = event.streams[0];
              setTimeout(() => {
                video.play();
              });
              console.log('received remote stream');
            }
          });

          const remoteSdp = clientIdAndMessage[1];
          await rtcConnection.setRemoteDescription({type: 'offer', sdp: remoteSdp});
          console.log('Set remote description on RTC connection');

          const answer = await rtcConnection.createAnswer();
          console.log('Created answer for RTC connection');
          rtcConnection.setLocalDescription(answer);
          websocket.send(JSON.stringify([clientId, answer.sdp]));
          hasSentSdp = true;
          sendIceCandidates();
          websocket.addEventListener('message', function (event) {
            console.log('Adding remote ICE candidate..');
            const clientIdAndMessage = JSON.parse(event.data);
            const iceCandidateClientId = clientIdAndMessage[0];
            const message = clientIdAndMessage[1];
            if (iceCandidateClientId === clientId) {
              rtcConnection.addIceCandidate(JSON.parse(message));
            }
          });
        }
        setupRtcConnection();
      }
    });
  </script>
</html>
